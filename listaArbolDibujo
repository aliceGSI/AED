#include <SFML/Graphics.hpp>
#include <iostream>
#include <sstream>
#include <cmath>
using namespace std;

struct Node
{
    int data;
    Node* next;
    Node* left;
    Node* right;
};

void push_back(Node*& head, int val)
{
    Node* nuevo = new Node;
    nuevo->data = val;
    nuevo->next = 0;
    nuevo->left = 0;
    nuevo->right = 0;
    if (!head)
    {
        head = nuevo;
        return;
    }
    Node* temp = head;
    while (temp->next)
    {
        temp = temp->next;
    }
    temp->next = nuevo;
}

Node* crearArbol(Node*& ini, Node*& fin)
{
    if (!ini) return 0;
    fin = ini;
    while (fin->next) fin = fin->next;
    Node* curr = ini;
    while (curr && curr->next)
    {
        Node* izq = curr;
        Node* der = curr->next;
        if (!der) break;
        Node* padre = new Node;
        padre->data = izq->data + der->data;
        padre->next = 0;
        padre->left = izq;
        padre->right = der;
        fin->next = padre;
        fin = padre;
        curr = der->next;
        if (!curr || !curr->next)
        {
            return padre;
        }
    }
    return fin;
}

void printList(Node* head)
{
    if (!head) return;

    Node* temp = head;
    while (temp)
    {
        cout << temp->data << " ";
        temp = temp->next;
    }
    cout << endl;
}

int getHeight(Node* root)
{
    if (!root)
        return 0;
    int leftH = getHeight(root->left);
    int rightH = getHeight(root->right);
    return 1 + (leftH > rightH ? leftH : rightH);
}

void drawTree(sf::RenderWindow& window, Node* root, float x, float y,
    float offsetX, sf::Font& font, int level = 0)
{
    if (!root) return;

    if (root->left)
    {
        float childX = x - offsetX;
        float childY = y + 80; //px
        sf::Vertex line[] = {
            sf::Vertex(sf::Vector2f(x, y), sf::Color::White),
            sf::Vertex(sf::Vector2f(childX, childY), sf::Color::White)
        };
        window.draw(line, 2, sf::Lines);
        drawTree(window, root->left, childX, childY, offsetX / 2, font, level + 1);
    }

    if (root->right)
    {
        float childX = x + offsetX;
        float childY = y + 80;
        sf::Vertex line[] = {
            sf::Vertex(sf::Vector2f(x, y), sf::Color::White),
            sf::Vertex(sf::Vector2f(childX, childY), sf::Color::White)
        };
        window.draw(line, 2, sf::Lines);
        drawTree(window, root->right, childX, childY, offsetX / 2, font, level + 1);
    }
    //n
    sf::CircleShape circle(25);
    circle.setPosition(x - 25, y - 25);

    if (!root->left && !root->right)
        circle.setFillColor(sf::Color(100, 150, 255)); //azul
    
    else
        circle.setFillColor(sf::Color(255, 100, 100)); //rojo

    circle.setOutlineThickness(2); //borde
    circle.setOutlineColor(sf::Color::White);
    window.draw(circle);

    //valor
    sf::Text text;
    text.setFont(font);

    stringstream ss;
    ss << root->data;
    text.setString(ss.str());
    text.setCharacterSize(18);
    text.setFillColor(sf::Color::White);

    sf::FloatRect textBounds = text.getLocalBounds(); //centrar
    text.setPosition(x - textBounds.width / 2, y - textBounds.height / 2 - 5);
    window.draw(text);
}

int main()
{
    Node* ini = 0;
    Node* fin = 0;

    cout << "Ejemplo 1: 8 elementos (2^3)" << endl;
    push_back(ini, 2);
    push_back(ini, 4);
    push_back(ini, 7);
    push_back(ini, 9);
    push_back(ini, 10);
    push_back(ini, 15);
    push_back(ini, 3);
    push_back(ini, 25);

    cout << "\nLista inicial: ";
    printList(ini);

    Node* raiz = crearArbol(ini, fin);

    cout << "\nLista completa (hojas + padres): ";
    printList(ini);
    cout << "\nAltura del arbol: " << getHeight(raiz) << endl;
    cout << "\nAbriendo ventana SFML para visualizar el arbol..." << endl;

    //smfl
    sf::RenderWindow window(sf::VideoMode(1200, 700), "Arbol Binario");
    window.setFramerateLimit(60);

    sf::Font font;
    if (!font.loadFromFile("C:\\Windows\\Fonts\\arial.ttf")) return -1;
    
    sf::Text titulo;
    titulo.setFont(font);
    titulo.setString("Arbol Binario");
    titulo.setCharacterSize(20);
    titulo.setFillColor(sf::Color::White);
    titulo.setPosition(20, 20);

    sf::Text instrucciones;
    instrucciones.setFont(font);
    instrucciones.setCharacterSize(16);
    instrucciones.setFillColor(sf::Color(200, 200, 200));
    instrucciones.setPosition(20, 650);

    while (window.isOpen())
    {
        sf::Event event;
        while (window.pollEvent(event))
        {
            if (event.type == sf::Event::Closed)
                window.close();

        }

        window.clear(sf::Color(30, 30, 40)); //plomo
        if (raiz)
        {
            drawTree(window, raiz, 600, 100, 250, font);
        }

        window.draw(titulo);
        window.draw(instrucciones);
        window.display();
    }

    return 0;
}
